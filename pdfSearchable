import os
import subprocess
import tempfile
import streamlit as st
import fitz  # pymupdf

# === ØªÙ†Ø¸ÛŒÙ…Ø§Øª ===
LANG = "fas+eng"

# === Ø³Ø¨Ú©â€ŒØ¯Ù‡ÛŒ Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† ===
st.markdown("""
<style>
    body, .stApp, .stMarkdown, .stText {
        direction: rtl;
        text-align: right;
        font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
    }
    .stButton>button {
        width: 100%;
        background-color: #4CAF50;
        color: white;
        border-radius: 8px;
    }
    .stDownloadButton>button {
        background-color: #2196F3;
        color: white;
        border-radius: 6px;
    }
</style>
""", unsafe_allow_html=True)

def get_pdf_page_count(pdf_path: str) -> int:
    try:
        with fitz.open(pdf_path) as doc:
            return len(doc)
    except Exception as e:
        st.warning(f"âš ï¸ Ù†ØªÙˆØ§Ù†Ø³Øª ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª {os.path.basename(pdf_path)} Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯: {e}")
        return 1  # Ø­Ø¯Ø³ Ø§ÙˆÙ„ÛŒÙ‡

def run_ocr_with_progress(input_path: str, output_path: str, total_pages: int, status_placeholder):
    command = [
        "ocrmypdf",
        "-l", LANG,
        "--force-ocr",
        "--verbose", "1",  # ÙØ¹Ø§Ù„â€ŒÚ©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ø¬Ø²Ø¦ÛŒ
        input_path,
        output_path,
    ]

    progress = 0
    progress_bar = st.progress(0)
    page_counter = st.empty()
    page_counter.text(f"ØµÙØ­Ù‡Ù” Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡: 0 Ø§Ø² {total_pages}")

    try:
        process = subprocess.Popen(
            command,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            bufsize=1,
            universal_newlines=True,
        )

        for line in iter(process.stdout.readline, ""):
            if "page" in line.lower() and ("processing" in line.lower() or "rendering" in line.lower()):
                progress += 1
                if progress <= total_pages:
                    percent = int((progress / total_pages) * 100)
                    progress_bar.progress(min(percent, 100))
                    page_counter.text(f"ØµÙØ­Ù‡Ù” Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡: {progress} Ø§Ø² {total_pages}")
                # else: ignore extra logs

        process.wait()
        progress_bar.progress(100)
        page_counter.text(f"âœ… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø§Ù…Ù„ Ø´Ø¯: {total_pages} ØµÙØ­Ù‡")
        return process.returncode == 0, ""

    except Exception as e:
        return False, str(e)

# === UI ===
st.set_page_config(page_title="ØªØ¨Ø¯ÛŒÙ„ pdf Ø¨Ù‡ pdf Ù‚Ø§Ø¨Ù„ Ø³Ø±Ú†", layout="wide")
st.title("ğŸ” ØªØ¨Ø¯ÛŒÙ„ pdf ØªØµÙˆÛŒØ±ÛŒ Ø¨Ù‡ pdf Ù‚Ø§Ø¨Ù„ Ø³Ø±Ú†")
st.markdown("ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PDF Ø®ÙˆØ¯ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯ â€” Ù¾ÛŒØ´Ø±ÙØª Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙØ­Ù‡â€ŒØ¨Ù‡â€ŒØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")

with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/3050/3050307.png", width=80)
    st.header("ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„")
    uploaded_files = st.file_uploader(
        "ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PDF Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯",
        type=["pdf"],
        accept_multiple_files=True
    )
    st.markdown("---")
    st.caption("âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ§Ø±Ø³ÛŒ + Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ\n\nğŸ“Š Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª ØµÙØ­Ù‡â€ŒØ¨Ù‡â€ŒØµÙØ­Ù‡")

if not uploaded_files:
    st.info("ğŸ‘ˆ Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PDF Ø±Ø§ Ø§Ø² Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.")
else:
    results = []
    for file in uploaded_files:
        st.markdown(f"### Ù¾Ø±Ø¯Ø§Ø²Ø´: `{file.name}`")
        
        with tempfile.TemporaryDirectory() as temp_dir:
            input_path = os.path.join(temp_dir, file.name)
            output_path = os.path.join(temp_dir, f"OCR_{file.name}")

            with open(input_path, "wb") as f:
                f.write(file.getbuffer())

            total_pages = get_pdf_page_count(input_path)
            st.caption(f"ğŸ“„ ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª: {total_pages}")

            success, error = run_ocr_with_progress(input_path, output_path, total_pages, None)

            if success and os.path.exists(output_path):
                with open(output_path, "rb") as f:
                    results.append((file.name, f.read()))
                st.success(f"âœ… `{file.name}` Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯!")
            else:
                st.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ `{file.name}`:\n```\n{error}\n```")

    if results:
        st.markdown("---")
        st.subheader("ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ OCR Ø´Ø¯Ù‡")
        for orig_name, pdf_bytes in results:
            st.download_button(
                label=f"â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ OCR_{orig_name}",
                data=pdf_bytes,
                file_name=f"OCR_{orig_name}",
                mime="application/pdf"
            )
        st.balloons()
